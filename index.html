<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國立臺灣大學社會責任「臺大。森林。學院2.0」農田微棲地生態設置小遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4;
        }
        .game-scene {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            max-width: 1200px;
            margin: auto;
            background: linear-gradient(to bottom, #87ceeb 30%, #a1d9a3 30%);
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border: 8px solid #654321;
        }
        #connection-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }
        .forest { position: absolute; top: 0; left: 0; width: 35%; height: 50%; background: #228b22; clip-path: polygon(0 0, 100% 0, 100% 60%, 80% 100%, 0 100%); z-index: 1; }
        .low-mountain { position: absolute; top: 5%; left: 20%; width: 40%; height: 40%; background: #556b2f; border-radius: 50% 50% 0 0; z-index: 0; }
        .farm-plot { position: absolute; background-color: #f5deb3; border: 2px solid #cd853f; }
        .farm-1 { top: 45%; left: 5%; width: 30%; height: 25%; transform: skew(-15deg); }
        .farm-2 { top: 50%; left: 40%; width: 35%; height: 30%; background-color: #d2b48c; }
        .farm-3 { top: 75%; left: 10%; width: 35%; height: 20%; transform: skew(10deg); }
        .stream { position: absolute; top: 30%; left: 70%; width: 25%; height: 70%; background: #add8e6; clip-path: polygon(20% 0, 40% 0, 75% 100%, 55% 100%); z-index: 5; }
        .pond { position: absolute; bottom: 5%; right: 5%; width: 25%; height: 20%; background: #4682b4; border-radius: 50%; z-index: 6; }
        .agricultural-facility { position: absolute; top: 35%; left: 55%; width: 100px; height: 80px; background: #8b4513; z-index: 4; }
        .agricultural-facility::after { content: ''; position: absolute; top: -40px; left: 0; width: 0; height: 0; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 40px solid #a0522d; }
        .farmhouse { position: absolute; bottom: 25%; left: 2%; width: 60px; height: 50px; background: #d2691e; z-index: 4; }
        .farmhouse::after { content: ''; position: absolute; top: -25px; left: 0; width: 0; height: 0; border-left: 30px solid transparent; border-right: 30px solid transparent; border-bottom: 25px solid #a0522d; }
        
        .road { position: absolute; top: 30%; left: 0; width: 100%; height: 8%; background: #696969; z-index: 3; }
        .landscape-label { position: absolute; color: white; background-color: rgba(0, 0, 0, 0.5); padding: 2px 8px; border-radius: 6px; font-size: 0.9rem; font-weight: bold; z-index: 20; pointer-events: none; }
        
        .game-icon { 
            position: absolute; 
            font-size: 0.8rem; /* MODIFIED: Reduced animal icon base size */
            text-align: center; 
            text-shadow: 0 1px 3px rgba(0,0,0,0.4); 
            transition: all 1s ease-in-out; 
            z-index: 25; 
        }
        .game-icon span { 
            display: block; 
            font-size: 0.6rem; /* MODIFIED: Reduced animal name font size */
            font-weight: bold; 
            color: #fff; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        }
        
        .disturbance-icon { transition: transform 0.5s ease-out; }
        .disturbance-icon .icon-symbol { font-size: 1.2rem; /* MODIFIED: Reduced disturbance icon size */ color: red; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes move-randomly { 0% { transform: translate(0, 0); } 25% { transform: translate(var(--x1), var(--y1)); } 50% { transform: translate(var(--x2), var(--y2)); } 75% { transform: translate(var(--x3), var(--y3)); } 100% { transform: translate(0, 0); } }
        .animal.active { animation: move-randomly 10s infinite; }
        
        .drop-zone { position: absolute; border: 3px dashed rgba(0, 128, 0, 0.7); background: rgba(144, 238, 144, 0.2); border-radius: 10px; z-index: 35; transition: background-color 0.3s; }
        
        .drop-zone.hovered { background: rgba(144, 238, 144, 0.5); }
        .drop-zone.occupied { border-style: solid; border-color: #228b22; background-color: transparent; }
        /* MODIFIED: Reduced facility card padding */
        .facility { cursor: grab; transition: transform 0.2s; padding: 0.25rem 0.5rem; }
        .facility:active { cursor: grabbing; transform: scale(1.1); z-index: 100; }
        .facility.placed { opacity: 0.5; cursor: not-allowed; background-color: #d1d5db; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; justify-content: center; align-items: center; }
        
        #animal-pen {
            position: absolute;
            top: 1%;
            right: 1%;
            width: auto;
            max-width: 40%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            padding: 4px;
            border-radius: 8px;
            z-index: 30;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .pen-animal {
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-green-50 text-gray-800 p-4 lg:p-8">

    <div id="game-container" class="max-w-7xl mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-green-800">國立臺灣大學社會責任「臺大。森林。學院2.0」</h1>
            <h2 class="text-xl md:text-2xl font-semibold text-green-700">農田微棲地生態設置小遊戲</h2>
        </header>

        <!-- MODIFIED: Changed layout to vertical stacking on all screen sizes -->
        <div class="flex flex-col gap-8">
            <main class="w-full">
                <div id="scene" class="game-scene">
                    <canvas id="connection-canvas"></canvas>
                    <div id="animal-pen"></div>
                    <div class="forest"></div>
                    <div class="low-mountain"></div>
                    <div class="road"></div>
                    <div class="farm-plot farm-1"></div>
                    <div class="farm-plot farm-2"></div>
                    <div class="farm-plot farm-3"></div>
                    <div class="stream"></div>
                    <div class="pond"></div>
                    <div class="agricultural-facility"></div>
                    <div class="farmhouse"></div>
                    <div class="landscape-label" style="top: 5%; left: 5%;">森林</div>
                    <div class="landscape-label" style="top: 10%; left: 30%;">淺山</div>
                    <div class="landscape-label" style="top: 55%; left: 15%;">農田</div>
                    <div class="landscape-label" style="top: 60%; left: 48%;">農田</div>
                    <div class="landscape-label" style="top: 80%; left: 20%;">農田</div>
                    <div class="landscape-label" style="top: 40%; left: 78%;">溪流</div>
                    <div class="landscape-label" style="bottom: 12%; right: 15%;">水塘</div>
                    <div class="landscape-label" style="top: 48%; left: 56%;">農業設施</div>
                    <div class="landscape-label" style="bottom: 33%; left: 3%;">農舍</div>
                    <div class="landscape-label" style="top: 31%; left: 2%;">山邊道路</div>
                </div>
                <div id="connection-counter" class="mt-2 text-center text-lg font-bold text-green-700 bg-green-100 p-2 rounded-lg">
                    已連接 0 個生態棲地
                </div>
            </main>

            <aside class="w-full bg-white p-4 rounded-lg shadow-lg">
                <h3 class="text-md font-bold border-b-2 border-green-600 pb-2 mb-2">生態設施 <span class="text-xs text-gray-500 font-normal">(使用手機請長按>移動卡牌)</span></h3>
                <div id="facilities-list" class="flex flex-row flex-wrap gap-2 justify-center"></div>
            </aside>
        </div>

        <footer class="text-center mt-6 text-xs text-gray-500">
            <p>共同開發單位：社團法人南投縣水里鄉商圈創生共好協會 | 社團法人南投縣青年農民永續發展協會 | 水里里山基地#里山餐桌團隊 #水里青農 | 水里營林區</p>
            <p>© 2025 水里永續共好聯盟 | V1.0，「里山餐桌」團隊設計</p>
        </footer>
    </div>

    <div id="feedback-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-11/12 md:max-w-lg mx-auto transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold text-green-700 mb-4">太棒了！</h3>
            <div id="modal-content" class="text-base text-left"></div>
            <button id="modal-close-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">繼續探索</button>
        </div>
    </div>
    <div id="sroi-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-11/12 md:max-w-2xl mx-auto transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold text-center text-yellow-500 mb-4">恭喜！您已成功串連所有關鍵棲地！</h3>
            <div class="text-base text-left space-y-6">
                <div>
                    <h4 class="text-xl font-bold text-green-800 border-b-2 border-green-200 pb-2 mb-3">👨‍🌾 給農友的永續紅利：生產與生態的雙贏</h4>
                    <ul class="list-disc list-inside space-y-2 text-gray-700">
                        <li><b>生態服務增強：</b>透過草帶、濕地吸引來的蜜蜂、瓢蟲、青蛙，能幫助作物授粉、吃掉害蟲，有效減少農藥與肥料成本，讓土地更健康。</li>
                        <li><b>品牌價值提升：</b>「為生態耕作」本身就是最棒的故事！生態友善的產品（如石虎米、穿山甲茶）能獲得消費者認同，創造更高的品牌價值與市場區隔。</li>
                        <li><b>社會資本累積：</b>展現農場的社會投資報酬率(SROI)，更容易爭取政府補助或企業的ESG合作，並成為社區引以為傲的環境教育場域。</li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-xl font-bold text-blue-800 border-b-2 border-blue-200 pb-2 mb-3">🤝 我們如何支持生態農友</h4>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-bold text-lg mb-2">🙋‍♀️ 身為消費者</h5>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><b>用新台幣下架：</b>優先購買有產銷履歷、綠色保育標章的產品。</li>
                                <li><b>親身體驗與分享：</b>參加食農教育、生態導覽，並在社群分享您的感動。</li>
                                <li><b>理解價值差異：</b>了解友善產品的價格，包含了對環境的愛護成本。</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-bold text-lg mb-2">🏢 身為企業</h5>
                            <ul class="list-disc list-inside space-y-2 text-gray-700">
                                <li><b>實踐 ESG/CSR：</b>將支持生態農業納入企業的永續發展策略中。</li>
                                <li><b>企業採購與合作：</b>採購友善農產品作為員工福利或企業贈禮。</li>
                                <li><b>投資生態復育：</b>贊助農場的生態設施（如認養一片濕地），作為企業的永續績效。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <button id="sroi-modal-close-btn" class="mt-8 w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-colors text-lg">我明白了！一起為永續努力！</button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA SETUP ---
        const gameData = {
            animals: [
                { id: 'leopard-cat-1', name: '石虎', icon: '🐆', position: { top: '35%', left: '15%' }, habitat: 'forest', released: false },
                { id: 'ferret-badger-1', name: '鼬獾', icon: '🦡', position: { top: '42%', left: '22%' }, habitat: 'forest', released: false },
                { id: 'snake-1', name: '蛇類', icon: '🐍', position: { top: '40%', left: '5%' }, habitat: 'forest', released: false },
                { id: 'tortoise-1', name: '陸龜', icon: '🐢', position: { top: '50%', left: '12%' }, habitat: 'forest', released: false },
                { id: 'frog-1', name: '諸羅樹蛙', icon: '🐸', position: { top: '56%', left: '8%' }, habitat: 'forest', released: false },
                { id: 'bird-1', name: '竹雞', icon: '🐔', position: { top: '20%', left: '10%' }, habitat: 'forest', released: false },
                { id: 'butterfly-3', name: '蝴蝶', icon: '🦋', position: { top: '25%', left: '20%' }, habitat: 'forest', released: false },
                { id: 'frog-2', name: '澤蛙', icon: '🐸', position: { top: '85%', left: '65%' }, habitat: 'water_edge', released: false },
                { id: 'bird-2', name: '白鷺', icon: '🦢', position: { top: '78%', left: '90%' }, habitat: 'water_edge', released: false },
                { id: 'fish-1', name: '魚類', icon: '🐟', position: { top: '65%', left: '82%' }, habitat: 'water_edge', released: false },
                { id: 'dragonfly-1', name: '蜻蜓', icon: '🦗', position: { top: '70%', left: '78%' }, habitat: 'water_edge', released: false },
                { id: 'aquatic-insect-1', name: '水生昆蟲', icon: '🦟', position: { top: '80%', left: '75%' }, habitat: 'water_edge', released: false },
                { id: 'firefly-2', name: '螢火蟲', icon: '💡', position: { top: '78%', left: '8%' }, habitat: 'water_edge', released: false },
                { id: 'frog-3', name: '澤蛙', icon: '🐸', position: { top: '95%', left: '35%' }, habitat: 'wetland', released: false },
                { id: 'tortoise-2', name: '烏龜', icon: '🐢', position: { top: '95%', left: '50%' }, habitat: 'wetland', released: false },
                { id: 'firefly-1', name: '螢火蟲', icon: '💡', position: { top: '82%', left: '42%' }, habitat: 'wetland', released: false },
                { id: 'dragonfly-2', name: '蜻蜓', icon: '🦗', position: { top: '83%', left: '48%' }, habitat: 'wetland', released: false },
                { id: 'aquatic-insect-2', name: '水黽', icon: '🦟', position: { top: '93%', left: '52%' }, habitat: 'wetland', released: false },
                { id: 'butterfly-2', name: '蝴蝶', icon: '🦋', position: { top: '82%', left: '33%' }, habitat: 'wetland', released: false },
                { id: 'frog-4', name: '青蛙', icon: '🐸', position: { top: '68%', left: '30%' }, habitat: 'farm_corridor', released: false },
                { id: 'bee-2', name: '蜜蜂', icon: '🐝', position: { top: '65%', left: '55%' }, habitat: 'farm_corridor', released: false },
                { id: 'butterfly-1', name: '蝴蝶', icon: '🦋', position: { top: '62%', left: '30%' }, habitat: 'farm_corridor', released: false },
                { id: 'bird-4', name: '竹雞', icon: '🐔', position: { top: '78%', left: '30%' }, habitat: 'farm_corridor', released: false },
                { id: 'ferret-badger-2', name: '鼬獾', icon: '🦡', position: { top: '62%', left: '25%' }, habitat: 'farm_corridor', released: false },
                { id: 'snake-3', name: '蛇類', icon: '🐍', position: { top: '56%', left: '56%' }, habitat: 'farm_corridor', released: false },
                { id: 'bee-1', name: '蜜蜂', icon: '🐝', position: { top: '48%', left: '53%' }, habitat: 'farm_building', released: false }, 
                { id: 'bird-5', name: '麻雀', icon: '🦜', position: { top: '40%', left: '54%' }, habitat: 'farm_building', released: false }, 
                { id: 'ferret-badger-3', name: '鼬獾', icon: '🦡', position: { top: '48%', left: '62%', habitat: 'farm_building', released: false }}, 
            ],
            disturbances: [
                { id: 'disturbance-dog', name: '流浪狗', icon: '🐕', position: { top: '55%', left: '20%' } },
                { id: 'disturbance-pesticide', name: '農藥漂移', icon: '☠️', position: { top: '60%', left: '60%' } },
                { id: 'disturbance-machine', name: '農機', icon: '🚜', position: { top: '78%', left: '55%' } },
                { id: 'disturbance-trash', name: '垃圾堆積', icon: '🗑️', position: { top: '40%', left: '85%' } },
                { id: 'disturbance-ditch', name: '水泥排水溝', icon: '🧱', position: { top: '75%', left: '2%' } },
                { id: 'disturbance-light', name: '過度照明', icon: '💡', position: { top: '25%', left: '45%' } },
                { id: 'disturbance-roadkill', name: '道路路殺', icon: '🚗', position: { top: '32%', left: '75%' } },
            ],
            facilities: [
                { id: 'f11', name: '森林緩衝帶', icon: '🌳', zone: 'dz11', placed: false, benefits: ['forest'], reason: '作為森林與農田之間的過渡區，能減緩農耕活動對森林的干擾，並提供石虎、鼬獾等較敏感的哺乳動物一個安全的覓食與移動前緣。', howto: '<strong>【寬度】</strong>在森林邊緣保留至少 5–10 公尺寬的區域。<br><strong>【植被】</strong>營造草本、灌木、小喬木等多層次的植被結構，模仿自然森林樣貌。' },
                { id: 'f1', name: '田埂草帶/廊道', icon: '🌿', zone: 'dz1', placed: false, benefits: ['farm_corridor'], reason: '提供授粉昆蟲(蝴蝶、蜜蜂)、天敵(蜘蛛、瓢蟲)及小型動物(青蛙、蛇)一個重要的庇護、覓食與移動的通道，串聯破碎的棲地。', howto: '<strong>【寬度】</strong>在田埂或田邊保留 1–3 公尺寬的未耕作區。<br><strong>【植被】</strong>讓原生草類自然生長，或種植馬利筋、萬壽菊等蜜源植物。<br><strong>【管理】</strong>禁止使用除草劑，可定期人工修剪以防過度蔓延。', sroiFarms: '湧健酪梨農場、雨社山下農場、指令教育農場、阿爾喜檸檬' },
                { id: 'f3', name: '生物友善涵洞', icon: '🐾', zone: 'dz3', placed: false, benefits: ['forest'], reason: '讓習慣在地面活動的動物（如鼬獾、食蛇龜、青蛙）可以安全穿越田間道路，避免被農機或車輛輾斃(路殺)。', howto: '<strong>【地點】</strong>設置在田間道路、田埂下方。<br><strong>【設計】</strong>內徑約 30-50 公分，內部需保持昏暗、濕潤，洞口兩側應有植被引導。', sroiFarms: '湧健酪梨農場、雨社山下農場' },
                { id: 'f5', name: '綠化水道', icon: '💧', zone: 'dz5', placed: false, benefits: ['water_edge'], reason: '取代傳統水泥溝，創造一個保水、保濕、降溫的微棲地，成為蝌蚪、蛇類、水生昆蟲的避難所與移動通道。', howto: '<strong>【結構】</strong>將溝渠改為自然土坡或鋪設卵石底，不做水泥化。<br><strong>【設計】</strong>兩側種植野薑花、香蒲等挺水植物，並放置石塊或枯木供動物躲藏。' },
                { id: 'f6', name: '小濕地', icon: '🐸', zone: 'dz6', placed: false, benefits: ['wetland'], reason: '在農田中創造一個生物多樣性熱點，是蛙類、蜻蜓、水鳥等動物繁殖、覓食、棲息的核心場所，也是絕佳的生態教育點。', howto: '<strong>【地點】</strong>利用田區角落的低窪處或休耕田。<br><strong>【設計】</strong>面積約 1.5–4 公尺，水深 0.5-1 公尺，邊坡緩降，底部可用黏土防漏。種植水燭、野慈姑等水生植物。' },
                { id: 'f8', name: '水岸緩衝帶', icon: '🌊', zone: 'dz8', placed: false, benefits: ['water_edge'], reason: '保護溪流、水塘的水質，能有效攔截、過濾從農田流出的農藥與肥料，同時提供豐富的濕地生態系讓多樣生物棲息。', howto: '<strong>【寬度】</strong>在水岸與農田間保留 5–15 公尺寬。<br><strong>【植被】</strong>由水邊至陸地，依序種植水生植物、草本層、灌木層，形成多層次保護。' },
                { id: 'f9', name: '自然化護岸', icon: '⛰️', zone: 'dz9', placed: false, benefits: ['water_edge'], reason: '將垂直陡峭的水泥堤岸，改造為動物可自由進出的緩坡。增加水陸交界的棲地多樣性，讓龜、蛙能輕易上下岸。', howto: '<strong>【方式】</strong>移除部分水泥塊，回填土壤，或使用柳條編織的石籠、植生袋等柔性材料打造緩坡。<br><strong>【設計】</strong>坡上可種植原生草本或灌木，穩定坡面。' },
                { id: 'f10', name: '漂浮棲地', icon: '🏝️', zone: 'dz10', placed: false, benefits: ['wetland'], reason: '在水域中提供一個穩定的平台，讓蜻蜓、豆娘等昆蟲可以停棲、產卵，也讓小青蛙有躲避水中天敵的休息站。', howto: '<strong>【材料】</strong>使用竹子、無毒塑膠管等製成框架，中間鋪設網或種植布。<br><strong>【植被】</strong>種植空心菜、水芙蓉等水生植物，根系可提供水中生物庇護。' },
                { id: 'f12', name: '枯木堆、草堆', icon: '🪵', zone: 'dz12', placed: false, benefits: ['forest','wetland'], reason: '提供一個穩定、溫濕度變化小的微環境，是蛇、蜥蜴、龜、蛙等變溫動物絕佳的躲藏、覓食或度冬的場所。', howto: '<strong>【地點】</strong>在森林邊緣、草帶或田區角落等不易受干擾處。<br><strong>【材料】</strong>將修剪下來的樹枝、枯木、落葉、稻草堆疊即可，不需過度整齊。', sroiFarms: '湧健酪梨農場' },
                { id: 'f13', name: '昆蟲旅館', icon: '🦋', zone: 'dz13', placed: false, benefits: ['farm_building'], reason: '為獨居蜂(如切葉蜂)等授粉昆蟲，以及瓢蟲、草蛉等天敵昆蟲，提供繁殖與過冬的住所，有助於作物授粉與生物防治。', howto: '<strong>【材料】</strong>使用木箱、竹筒、鑽孔木塊、稻草、松果等天然材料堆疊而成。<br><strong>【地點】</strong>設置在草帶、果園旁，離地約 30-100 公分。'},
                { id: 'f14', name: '1959動保專線', icon: '📞', zone: 'dz_dog', placed: false, removes: 'disturbance-dog', reason: '通報流浪犬隻能幫助相關單位進行適當的安置，減少牠們對野生動物（如石虎、穿山甲）的追逐與攻擊，保護淺山生態系的安全。', howto: '撥打1959動保專線，清楚說明流浪犬的位置、數量、特徵，讓專業人員能有效處理。'},
            ],
            dropZones: [
                {id:'dz1',position:{top:'71%',left:'5%',width:'28%',height:'4%'},cx:19,cy:73},
                {id:'dz3',position:{top:'32%',left:'50%',width:'5%',height:'6%'},cx:52.5,cy:35},
                {id:'dz5',position:{top:'70%',left:'2%',width:'3%',height:'25%'},cx:3.5,cy:82.5},
                {id:'dz6',position:{top:'85%',left:'25%',width:'22%',height:'10%'},cx:36,cy:90},
                {id:'dz8',position:{top:'40%',left:'68%',width:'8%',height:'38%'},cx:72,cy:59},
                {id:'dz9',position:{top:'50%',left:'93%',width:'5%',height:'30%'},cx:95.5,cy:65},
                {id:'dz10',position:{top:'82%',left:'78%',width:'15%',height:'10%'},cx:85.5,cy:87},
                {id:'dz11',position:{top:'38%',left:'30%',width:'22%',height:'8%'},cx:41,cy:42},
                {id:'dz12',position:{top:'45%',left:'0%',width:'10%',height:'10%'},cx:5,cy:50},
                {id:'dz13',position:{top:'68%',left:'42%',width:'10%',height:'10%'},cx:47,cy:73},
                {id:'dz_dog', position:{top:'55%',left:'20%',width:'6%',height:'8%'},cx:23,cy:59}, 
            ],
            habitatAnchors: {
                forest:{cx:20,cy:30,name:'森林'},
                water_edge:{cx:80,cy:50,name:'水域邊緣'},
                wetland:{cx:88,cy:88,name:'濕地'},
                farm_building:{cx:60, cy:40, name: '設施周邊'},
                farm_corridor: {cx:30, cy:65, name: '田間廊道'}
            }
        };

        const scene = document.getElementById('scene');
        const facilitiesList = document.getElementById('facilities-list');
        const feedbackModal = document.getElementById('feedback-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const sroiModal = document.getElementById('sroi-modal');
        const sroiModalCloseBtn = document.getElementById('sroi-modal-close-btn');
        const connectionCounterEl = document.getElementById('connection-counter');
        const canvas = document.getElementById('connection-canvas');
        const ctx = canvas.getContext('2d');
        const animalPen = document.getElementById('animal-pen');
        
        let sceneRect, draggedItem = null, connectedHabitats = new Set(), sroiModalShown = false, placedFacilitiesCount = 0;

        function init() {
            setTimeout(resizeCanvas, 0);
            window.addEventListener('resize', resizeCanvas);
            
            const animalTypes = [...new Map(gameData.animals.map(item => [item.name, item])).values()];
            animalTypes.forEach(animal => {
                const penEl = document.createElement('div');
                penEl.id = `pen-${animal.name}`;
                penEl.className = 'pen-animal text-2xl';
                penEl.textContent = animal.icon;
                animalPen.appendChild(penEl);
            });
            
            renderElements(gameData.animals, createAnimalElement);
            renderElements(gameData.disturbances, createDisturbanceElement);
            renderElements(gameData.facilities, createFacilityElement);
            renderElements(gameData.dropZones, createDropZoneElement);
            
            modalCloseBtn.addEventListener('click', hideFeedbackModal);
            sroiModalCloseBtn.addEventListener('click', hideSroiModal);
            feedbackModal.addEventListener('click', (e) => { if (e.target === feedbackModal) hideFeedbackModal(); });
            sroiModal.addEventListener('click', (e) => { if (e.target === sroiModal) hideSroiModal(); });
        }
        
        function resizeCanvas() {
            sceneRect = scene.getBoundingClientRect();
            canvas.width = sceneRect.width;
            canvas.height = sceneRect.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            gameData.facilities.forEach(facilityData => {
                if (facilityData.placed) {
                    const dropZoneData = gameData.dropZones.find(dz => dz.id === facilityData.zone);
                    facilityData.benefits?.forEach(habitatKey => {
                        const habitatAnchor = gameData.habitatAnchors[habitatKey];
                        if (dropZoneData && habitatAnchor) drawConnectionLine(dropZoneData, habitatAnchor);
                    });
                }
            });
        }

        function renderElements(data, createElementFunc) {
            data.forEach(item => {
                const element = createElementFunc(item);
                if (element && element.classList.contains('facility')) {
                    facilitiesList.appendChild(element);
                } else if (element) {
                    scene.appendChild(element);
                }
            });
        }

        function createIconElement(t,e=!1){const o=document.createElement("div");return o.id=t.id,o.className="game-icon",e?(o.classList.add("disturbance-icon"),o.innerHTML=`<div class="icon-symbol">❗️</div><span>${t.name}</span><div class="text-xl">${t.icon}</div>`):(o.classList.add("animal"),o.dataset.habitat=t.habitat,o.innerHTML=`<div class="text-3xl">${t.icon}</div><span>${t.name}</span>`),o.style.top=t.position.top,o.style.left=t.position.left,o}

        function createAnimalElement(animal) {
            const el = createIconElement(animal, false);
            el.style.opacity = '0';
            el.style.transform = 'scale(0)';
            el.style.top = '5%';
            el.style.left = '95%';
            return el;
        }
        
        function createDisturbanceElement(t){return createIconElement(t,!0)}

        function createFacilityElement(facility) {
            const el = document.createElement('div');
            el.id = facility.id;
            el.dataset.zone = facility.zone;
            el.className = 'facility bg-lime-100 p-2 rounded-lg border border-lime-300 flex items-center gap-2';
            el.draggable = true;
            el.innerHTML = `<span class="text-lg">${facility.icon}</span><span class="text-xs">${facility.name}</span>`;
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragend', handleDragEnd);
            return el;
        }

        function createDropZoneElement(t){const e=document.createElement("div");return e.id=t.id,e.className="drop-zone",e.style.top=t.position.top,e.style.left=t.position.left,e.style.width=t.position.width,e.style.height=t.position.height,e.addEventListener("dragover",handleDragOver),e.addEventListener("dragleave",handleDragLeave),e.addEventListener("drop",handleDrop),e}

        function handleDragStart(t){draggedItem=t.target;setTimeout(()=>draggedItem&&(draggedItem.style.display="none"),0)}
        function handleDragEnd(t){draggedItem&&(draggedItem.style.display="flex"),draggedItem=null}
        function handleDragOver(t){t.preventDefault(),t.target.classList.contains("drop-zone")&&t.target.classList.add("hovered")}
        function handleDragLeave(t){t.target.classList.contains("drop-zone")&&t.target.classList.remove("hovered")}
        
        function handleDrop(e){
            e.preventDefault();
            const o=e.target.closest(".drop-zone");
            if(o&&!o.classList.contains("occupied")){
                o.classList.remove("hovered");
                const t=gameData.facilities.find(t=>t.id===draggedItem.id);
                if (t && t.zone === o.id) {
                    placeFacility(draggedItem,o,t);
                } else {
                    showFeedbackModal(!1)
                }
            }
        }

        function releaseAnimals(habitats) {
            gameData.animals.forEach(animal => {
                if (habitats.includes(animal.habitat) && !animal.released) {
                    animal.released = true;
                    const animalEl = document.getElementById(animal.id);
                    const penEl = document.getElementById(`pen-${animal.name}`);
                    
                    if (animalEl) {
                        animalEl.style.top = animal.position.top;
                        animalEl.style.left = animal.position.left;
                        animalEl.style.opacity = '1';
                        animalEl.style.transform = 'scale(1)';
                    }
                    if(penEl) {
                       penEl.style.opacity = '0.2';
                    }
                }
            });
            activateAnimals(habitats);
        }

        function placeFacility(facilityEl, zoneEl, facilityData) {
            facilityData.placed = true;
            placedFacilitiesCount++;
            facilityEl.classList.add('placed');
            facilityEl.draggable = false;
            zoneEl.innerHTML = `<div class="w-full h-full flex items-center justify-center text-green-800 font-bold bg-green-200/80 p-1 text-xs text-center">${facilityData.name}</div>`;
            zoneEl.classList.add('occupied');
            
            showFeedbackModal(true, facilityData);
            updateDisturbanceIcons();

            if (facilityData.removes) {
                const targetEl = document.getElementById(facilityData.removes);
                if (targetEl) {
                    targetEl.style.transition = 'opacity 0.5s, transform 0.5s';
                    targetEl.style.opacity = '0';
                    targetEl.style.transform = 'scale(0)';
                    setTimeout(() => targetEl.remove(), 500);
                }
            }
            
            if (facilityData.benefits) {
                releaseAnimals(facilityData.benefits);
                const dropZoneData = gameData.dropZones.find(dz => dz.id === zoneEl.id);
                facilityData.benefits.forEach(habitatKey => {
                    const habitatAnchor = gameData.habitatAnchors[habitatKey];
                    if (dropZoneData && habitatAnchor) {
                        drawConnectionLine(dropZoneData, habitatAnchor);
                        connectedHabitats.add(habitatAnchor.name);
                    }
                });
                updateConnectionCounter();
            }
            
            checkCompletion();
        }
        
        function updateConnectionCounter(){const t=connectedHabitats.size;connectionCounterEl.textContent=`已連接 ${t} 個生態棲地：${[...connectedHabitats].join("、")}`,t>0&&(connectionCounterEl.classList.remove("bg-green-100","text-green-700"),connectionCounterEl.classList.add("bg-yellow-200","text-yellow-800"))}
        function updateDisturbanceIcons(){const t=document.querySelectorAll(".disturbance-icon"),e=Math.max(.1,1-placedFacilitiesCount/gameData.facilities.length);t.forEach(t=>{t.style.transform=`scale(${e})`})}
        function checkCompletion(){gameData.facilities.every(t=>t.placed)&&!sroiModalShown&&(sroiModalShown=!0,setTimeout(showSroiModal,1200))}
        
        function showFeedbackModal(isCorrect, data) {
            const modalDiv = feedbackModal.querySelector('div > div');
            if (!modalDiv) return;

            if (isCorrect) {
                modalTitle.textContent = `做得好！這是「${data.name}」`;
                let sroiHtml = '';
                if (data.sroiFarms) {
                    sroiHtml = `
                    <div class="mt-4 p-3 border-2 border-green-600 bg-green-50 rounded-lg">
                        <p class="font-bold text-green-800">⭐ 已完成本項設施並計算SROI之農場：</p>
                        <p class="text-gray-700">${data.sroiFarms}</p>
                    </div>
                    `;
                }
                
                modalContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-lg font-semibold text-green-800 border-l-4 border-green-500 pl-2 mb-1">🌿 生態功能</h4>
                            <p class="text-gray-700 leading-relaxed">${data.reason}</p>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-green-800 border-l-4 border-green-500 pl-2 mb-1">🛠️ 如何建造</h4>
                            <div class="text-gray-700 leading-relaxed">${data.howto}</div>
                        </div>
                         <div class="mt-4 p-3 border-2 border-blue-400 bg-blue-50 rounded-lg">
                            <p class="text-blue-800">因為您設置了生態保護措施，注意農村畫布中的驚嘆號會逐漸縮小；這些干擾生態的農業生產行為並不是消失了，而是因為友善生態，讓原有的干擾對生態的影響降得更低了!這樣良善的循環中，農友漸漸受益於生態，化學資材的使用也會逐漸降低!</p>
                        </div>
                        ${sroiHtml}
                    </div>
                `;
            } else {
                modalTitle.textContent = "噢喔，再試一次！";
                modalContent.innerHTML = "<p>這個位置好像不太對喔，想想看這個設施最能幫助到哪些生物，以及它應該放在哪裡才能發揮最大作用呢？</p>";
            }
            feedbackModal.classList.remove("hidden");
            setTimeout(() => { modalDiv.classList.remove("scale-95", "opacity-0"); }, 10);
        }
        
        function hideFeedbackModal(){
            const modalDiv = feedbackModal.querySelector('div > div');
            if (!modalDiv) return;
            modalDiv.classList.add("scale-95","opacity-0");
            setTimeout(()=>{feedbackModal.classList.add("hidden")},300);
        }

        function showSroiModal(){
            const modalDiv = sroiModal.querySelector('div > div');
            if (!modalDiv) return;
            sroiModal.classList.remove("hidden");
            setTimeout(()=>{ modalDiv.classList.remove("scale-95","opacity-0")},10);
        }

        function hideSroiModal(){
            const modalDiv = sroiModal.querySelector('div > div');
            if (!modalDiv) return;
            modalDiv.classList.add("scale-95","opacity-0");
            setTimeout(()=>{sroiModal.classList.add("hidden")},300);
        }

        function activateAnimals(t){document.querySelectorAll(".animal").forEach(e=>{t.includes(e.dataset.habitat)&&(e.classList.add("active"),e.style.setProperty("--x1",`${20*(Math.random()-.5)}px`),e.style.setProperty("--y1",`${20*(Math.random()-.5)}px`),e.style.setProperty("--x2",`${20*(Math.random()-.5)}px`),e.style.setProperty("--y2",`${20*(Math.random()-.5)}px`),e.style.setProperty("--x3",`${20*(Math.random()-.5)}px`),e.style.setProperty("--y3",`${20*(Math.random()-.5)}px`))})}
        function drawConnectionLine(t,e){const o=t.cx/100*canvas.width,i=t.cy/100*canvas.height,n=e.cx/100*canvas.width,d=e.cy/100*canvas.height;ctx.beginPath(),ctx.moveTo(o,i),ctx.lineTo(n,d),ctx.strokeStyle="rgba(255, 255, 0, 0.8)",ctx.lineWidth=4,ctx.setLineDash([5,5]),ctx.stroke()}
        
        init();
    });
    </script>
</body>
</html>
